<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Network Purchase Analysis Benchmark</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .tab-content {
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 0.25rem 0.25rem;
        }
        .benchmark-card {
            margin-bottom: 1rem;
        }
        .result-table {
            font-size: 0.9rem;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 2rem;
        }
        .db-comparison-card {
            border-left: 4px solid;
            margin-bottom: 1rem;
        }
        .db-postgresql {
            border-color: #336791;
        }
        .db-neo4j {
            border-color: #018bff;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .winner-badge {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            margin-left: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Social Network Purchase Analysis Benchmark</h1>
        
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generate" type="button" role="tab" aria-controls="generate" aria-selected="true">Generate Data</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="benchmark-tab" data-bs-toggle="tab" data-bs-target="#benchmark" type="button" role="tab" aria-controls="benchmark" aria-selected="false">Run Benchmark</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="results-tab" data-bs-toggle="tab" data-bs-target="#results" type="button" role="tab" aria-controls="results" aria-selected="false">Results</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="db-metrics-tab" data-bs-toggle="tab" data-bs-target="#db-metrics" type="button" role="tab" aria-controls="db-metrics" aria-selected="false">DB Performance</button>
            </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
            <!-- Generate Data Tab -->
            <div class="tab-pane fade show active" id="generate" role="tabpanel" aria-labelledby="generate-tab">
                <h3 class="mb-3">Generate Test Data</h3>
                <form id="generate-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="users" class="form-label">Number of Users</label>
                            <input type="number" class="form-control" id="users" name="users" min="1" max="1000000" value="1000">
                            <div class="form-text">Number of users to generate (1 - 1,000,000)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="products" class="form-label">Number of Products</label>
                            <input type="number" class="form-control" id="products" name="products" min="1" max="10000" value="100">
                            <div class="form-text">Number of products to generate (1 - 10,000)</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="max_follows" class="form-label">Max Follows per User</label>
                            <input type="number" class="form-control" id="max_follows" name="max_follows" min="0" max="100" value="20">
                            <div class="form-text">Maximum number of follows per user (0 - 100)</div>
                        </div>
                        <div class="col-md-6">
                            <label for="max_purchases" class="form-label">Max Purchases per User</label>
                            <input type="number" class="form-control" id="max_purchases" name="max_purchases" min="0" max="20" value="5">
                            <div class="form-text">Maximum number of purchases per user (0 - 20)</div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Generate Data</button>
                </form>
                
                <div id="generate-status" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <h5 id="generate-status-title">Data Generation in Progress</h5>
                        <p id="generate-status-message">Generating data...</p>
                        <div class="progress">
                            <div id="generate-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Run Benchmark Tab -->
            <div class="tab-pane fade" id="benchmark" role="tabpanel" aria-labelledby="benchmark-tab">
                <h3 class="mb-3">Run Performance Benchmark</h3>
                <form id="benchmark-form">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="test_type" class="form-label">Test Type</label>
                            <select class="form-select" id="test_type" name="test_type">
                                <option value="all" selected>All Tests</option>
                                <option value="product_virality">Product Virality</option>
                                <option value="user_influence">User Influence</option>
                                <option value="viral_products">Viral Products</option>
                            </select>
                            <div class="form-text">Type of benchmark to run</div>
                        </div>
                        <div class="col-md-6">
                            <label for="max_level" class="form-label">Max Level</label>
                            <input type="number" class="form-control" id="max_level" name="max_level" min="1" max="5" value="3">
                            <div class="form-text">Maximum level for social network depth (1 - 5)</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="product_id" class="form-label">Product ID</label>
                            <input type="text" class="form-control" id="product_id" name="product_id" placeholder="Enter product ID (integer)">
                            <div class="form-text">Product ID for virality test</div>
                        </div>
                        <div class="col-md-4">
                            <label for="user_id" class="form-label">User ID</label>
                            <input type="text" class="form-control" id="user_id" name="user_id" placeholder="Enter user ID (integer)">
                            <div class="form-text">User ID for influence test</div>
                        </div>
                        <div class="col-md-4">
                            <label for="iterations" class="form-label">Iterations</label>
                            <input type="number" class="form-control" id="iterations" name="iterations" min="1" max="10" value="5">
                            <div class="form-text">Number of iterations per test (1 - 10)</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <button type="button" id="fetch-random-ids" class="btn btn-outline-secondary mb-3">Fetch Random IDs</button>
                            <div id="random-ids-status" class="form-text"></div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">Run Benchmark</button>
                </form>
                
                <div id="benchmark-status" class="mt-4" style="display: none;">
                    <div class="alert alert-info">
                        <h5 id="benchmark-status-title">Benchmark in Progress</h5>
                        <p id="benchmark-status-message">Running benchmark...</p>
                        <div class="progress mb-3">
                            <div id="benchmark-progress" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="benchmark-details" class="card bg-light mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Details</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <strong>Current Operation:</strong>
                                    </div>
                                    <div class="col-md-8" id="benchmark-current-operation">
                                        Initializing...
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <strong>Progress:</strong>
                                    </div>
                                    <div class="col-md-8">
                                        <span id="benchmark-step-progress">0</span>/<span id="benchmark-total-steps">0</span> steps
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Elapsed Time:</strong>
                                    </div>
                                    <div class="col-md-8" id="benchmark-elapsed-time">
                                        0:00
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="benchmark-warning" class="alert alert-warning mt-3" style="display: none;">
                            <strong>Note:</strong> <span id="benchmark-warning-message"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results Tab -->
            <div class="tab-pane fade" id="results" role="tabpanel" aria-labelledby="results-tab">
                <h3 class="mb-3">Benchmark Results</h3>
                <button id="refresh-results" class="btn btn-outline-primary mb-3">Refresh Results</button>
                
                <div id="benchmarks-list" class="row">
                    <!-- Benchmark cards will be added here dynamically -->
                </div>
                
                <div id="result-details" class="mt-4" style="display: none;">
                    <h4 id="result-title">Benchmark Results</h4>
                    
                    <div class="chart-container" style="height: 400px; margin-bottom: 30px;">
                        <canvas id="results-chart"></canvas>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active" id="view-avg">Average Time</button>
                                <button type="button" class="btn btn-outline-primary" id="view-min">Min Time</button>
                                <button type="button" class="btn btn-outline-primary" id="view-max">Max Time</button>
                                <button type="button" class="btn btn-outline-primary" id="view-median">Median Time</button>
                            </div>
                        </div>
                    </div>
                    
                    <table class="table table-striped table-bordered result-table">
                        <thead>
                            <tr>
                                <th>Test Name</th>
                                <th>PostgreSQL Avg (s)</th>
                                <th>Neo4j Avg (s)</th>
                                <th>Faster</th>
                                <th>Speedup</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Results will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- DB Metrics Tab -->
            <div class="tab-pane fade" id="db-metrics" role="tabpanel" aria-labelledby="db-metrics-tab">
                <h3 class="mb-3">Database Performance Metrics</h3>
                <p>Compare the performance of PostgreSQL and Neo4j for data insertion operations.</p>
                
                <div class="alert alert-info mb-3" id="db-metrics-info">
                    Select a data generation task from the dropdown or click "Load Latest Metrics" to view the most recent performance metrics.
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-8">
                        <select class="form-select" id="task-id-select">
                            <option value="">Select a generation task...</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" id="load-latest-metrics-btn">Load Latest Metrics</button>
                    </div>
                </div>
                
                <div id="db-metrics-content" style="display: none;">
                    <h4>Overview</h4>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Generated Data</h5>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="metric-label">Users</div>
                                            <div class="metric-value" id="users-count">0</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="metric-label">Products</div>
                                            <div class="metric-value" id="products-count">0</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="metric-label">Follows</div>
                                            <div class="metric-value" id="follows-count">0</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="metric-label">Purchases</div>
                                            <div class="metric-value" id="purchases-count">0</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">Total Time</h5>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <div class="metric-label">PostgreSQL</div>
                                            <div class="metric-value" id="pg-total-time">0s</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <div class="metric-label">Neo4j</div>
                                            <div class="metric-value" id="neo4j-total-time">0s</div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="metric-label">Overall Winner</div>
                                            <div class="metric-value" id="overall-winner">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4>Operation Breakdown</h4>
                    <div class="row mb-4" id="operations-container">
                        <!-- Operation cards will be added here -->
                    </div>
                    
                    <h4>Memory Usage</h4>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Memory Statistics</h5>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <th>Peak Memory</th>
                                                <td id="peak-memory">0 MB</td>
                                            </tr>
                                            <tr>
                                                <th>Final Memory</th>
                                                <td id="final-memory">0 MB</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Errors</h5>
                                    <table class="table table-sm">
                                        <tbody>
                                            <tr>
                                                <th>PostgreSQL Errors</th>
                                                <td id="pg-errors">0</td>
                                            </tr>
                                            <tr>
                                                <th>Neo4j Errors</th>
                                                <td id="neo4j-errors">0</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Global variables
        let currentGenerateId = null;
        let currentBenchmarkId = null;
        let resultsChart = null;
        
        // API base URL - set to the correct port
        const API_BASE_URL = 'http://localhost:8005';
        
        // DOM elements
        const generateForm = document.getElementById('generate-form');
        const generateStatus = document.getElementById('generate-status');
        const generateStatusTitle = document.getElementById('generate-status-title');
        const generateStatusMessage = document.getElementById('generate-status-message');
        const generateProgress = document.getElementById('generate-progress');
        
        const benchmarkForm = document.getElementById('benchmark-form');
        const benchmarkStatus = document.getElementById('benchmark-status');
        const benchmarkStatusTitle = document.getElementById('benchmark-status-title');
        const benchmarkStatusMessage = document.getElementById('benchmark-status-message');
        const benchmarkProgress = document.getElementById('benchmark-progress');
        
        const benchmarksList = document.getElementById('benchmarks-list');
        const resultDetails = document.getElementById('result-details');
        const resultTitle = document.getElementById('result-title');
        const resultsTableBody = document.getElementById('results-table-body');
        const refreshResultsBtn = document.getElementById('refresh-results');
        
        // Event listeners
        generateForm.addEventListener('submit', handleGenerateSubmit);
        benchmarkForm.addEventListener('submit', handleBenchmarkSubmit);
        refreshResultsBtn.addEventListener('click', loadBenchmarks);
        document.getElementById('fetch-random-ids').addEventListener('click', fetchRandomIds);
        
        // Load benchmarks on page load
        document.addEventListener('DOMContentLoaded', loadBenchmarks);
        
        // Fetch random product and user IDs
        async function fetchRandomIds() {
            try {
                const statusElement = document.getElementById('random-ids-status');
                statusElement.textContent = 'Fetching random IDs...';
                
                const response = await fetch(`${API_BASE_URL}/benchmark/random-ids`);
                const data = await response.json();
                
                if (data.product_id && data.user_id) {
                    document.getElementById('product_id').value = data.product_id;
                    document.getElementById('user_id').value = data.user_id;
                    statusElement.textContent = 'Random IDs fetched successfully!';
                } else {
                    statusElement.textContent = 'No IDs available. Please generate data first.';
                }
            } catch (error) {
                console.error('Error fetching random IDs:', error);
                document.getElementById('random-ids-status').textContent = 'Error fetching random IDs. See console for details.';
            }
        }
        
        // Handle generate form submission
        async function handleGenerateSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(generateForm);
            const params = new URLSearchParams();
            
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }
            
            // Show status immediately with initial message
            generateStatus.style.display = 'block';
            generateStatusTitle.textContent = 'Data Generation in Progress';
            generateStatusMessage.textContent = 'Starting data generation...';
            generateProgress.style.width = '5%';
            
            try {
                const response = await fetch(`${API_BASE_URL}/benchmark/generate?${params.toString()}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Generation started with data:", data);
                
                // Look for task ID in various possible properties
                let taskId = null;
                if (data.benchmark_id) {
                    taskId = data.benchmark_id;
                } else if (data.task_id) {
                    taskId = data.task_id;
                } else if (data.id) {
                    taskId = data.id;
                }
                
                if (taskId) {
                    currentGenerateId = taskId;
                    console.log("Using task ID:", currentGenerateId);
                    
                    // Update status with any initial information
                    generateStatusMessage.textContent = data.message || 'Generating users and products...';
                    generateProgress.style.width = `${data.progress || 10}%`;
                    
                    // Start polling for status
                    setTimeout(pollGenerateStatus, 1000); // Start polling after 1 second
                } else {
                    // If no task ID is available but the request was successful, show a success message
                    // This handles the case where the server doesn't return a task ID but still processes the request
                    console.warn("No task ID returned, but request was successful. Cannot poll for progress.");
                    generateStatusTitle.textContent = 'Data Generation Started';
                    generateStatusMessage.textContent = data.message || 'Data generation started successfully. Progress updates are not available.';
                    generateStatus.classList.remove('alert-info');
                    generateStatus.classList.add('alert-success');
                    generateProgress.style.width = '100%';
                }
            } catch (error) {
                console.error('Error starting data generation:', error);
                generateStatus.classList.remove('alert-info');
                generateStatus.classList.add('alert-danger');
                generateStatusTitle.textContent = 'Error';
                generateStatusMessage.textContent = `Error starting data generation: ${error.message}`;
            }
        }
        
        // Poll for generate status
        async function pollGenerateStatus() {
            if (!currentGenerateId) {
                console.error("No current generation ID to poll");
                return;
            }
            
            try {
                console.log("Polling status for data generation:", currentGenerateId);
                const response = await fetch(`${API_BASE_URL}/benchmark/status/${currentGenerateId}`);
                
                if (!response.ok) {
                    throw new Error(`Server responded with status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Generation status data:", data);
                
                // Check if we got a valid response
                if (!data || typeof data !== 'object') {
                    throw new Error("Invalid response format");
                }
                
                // Update status with detailed information
                const detailedMessage = data.message || 'Processing...';
                generateStatusMessage.textContent = `Generating data: ${detailedMessage}`;
                
                // Ensure progress is always showing something (minimum 5%)
                const progressValue = Math.max(5, data.progress || 0);
                generateProgress.style.width = `${progressValue}%`;
                generateProgress.setAttribute('aria-valuenow', progressValue);
                
                if (data.status === 'completed') {
                    console.log("Data generation completed!");
                    generateStatusTitle.textContent = 'Data Generation Completed';
                    generateStatus.classList.remove('alert-info');
                    generateStatus.classList.add('alert-success');
                    generateProgress.style.width = '100%';
                    generateProgress.setAttribute('aria-valuenow', 100);
                    
                    // Load the metrics for this completed task
                    if (window.loadMetricsForTask) {
                        window.loadMetricsForTask(currentGenerateId);
                    } else {
                        console.warn("loadMetricsForTask function not available");
                    }
                    
                    // Switch to DB metrics tab
                    const dbMetricsTab = document.getElementById('db-metrics-tab');
                    if (dbMetricsTab) {
                        dbMetricsTab.click();
                    } else {
                        console.warn("DB metrics tab element not found");
                    }
                } else if (data.status === 'failed') {
                    console.error("Data generation failed:", data.message);
                    generateStatusTitle.textContent = 'Data Generation Failed';
                    generateStatus.classList.remove('alert-info');
                    generateStatus.classList.add('alert-danger');
                    generateStatusMessage.textContent = `Error: ${data.message || 'Unknown error'}`;
                } else {
                    // Continue polling
                    setTimeout(pollGenerateStatus, 1000);
                }
            } catch (error) {
                console.error('Error polling generate status:', error);
                generateStatusTitle.textContent = 'Error';
                generateStatusMessage.textContent = `Error polling status: ${error.message}`;
                generateStatus.classList.remove('alert-info');
                generateStatus.classList.add('alert-danger');
                
                // Try again in 5 seconds if it was a network error
                if (error.name === 'TypeError' || error.message.includes('network')) {
                    console.log("Network error, will retry in 5 seconds");
                    setTimeout(pollGenerateStatus, 5000);
                }
            }
        }
        
        // Handle benchmark form submission
        async function handleBenchmarkSubmit(event) {
            event.preventDefault();
            
            const formData = new FormData(benchmarkForm);
            const params = new URLSearchParams();
            
            // Process form data and handle empty fields
            for (const [key, value] of formData.entries()) {
                // Only include non-empty values for product_id and user_id
                if ((key === 'product_id' || key === 'user_id') && !value.trim()) {
                    continue; // Skip empty product_id or user_id
                }
                params.append(key, value);
            }
            
            console.log("Submitting benchmark with params:", params.toString());
            
            try {
                const response = await fetch(`${API_BASE_URL}/benchmark/run?${params.toString()}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log("Benchmark started:", data);
                currentBenchmarkId = data.benchmark_id;
                
                // Show status
                benchmarkStatus.style.display = 'block';
                benchmarkStatusTitle.textContent = 'Benchmark in Progress';
                benchmarkStatusMessage.textContent = data.message;
                benchmarkProgress.style.width = '0%';
                
                // Start polling for status
                pollBenchmarkStatus();
            } catch (error) {
                console.error('Error starting benchmark:', error);
                alert('Error starting benchmark. See console for details.');
            }
        }
        
        // Poll for benchmark status
        async function pollBenchmarkStatus() {
            if (!currentBenchmarkId) return;
            
            try {
                console.log("Polling status for benchmark:", currentBenchmarkId);
                const response = await fetch(`${API_BASE_URL}/benchmark/status/${currentBenchmarkId}`);
                const data = await response.json();
                console.log("Benchmark status:", data);
                
                // Update basic status
                benchmarkStatusMessage.textContent = data.message;
                benchmarkProgress.style.width = `${data.progress}%`;
                
                // Update detailed information
                const currentOperation = document.getElementById('benchmark-current-operation');
                const stepProgress = document.getElementById('benchmark-step-progress');
                const totalSteps = document.getElementById('benchmark-total-steps');
                const elapsedTime = document.getElementById('benchmark-elapsed-time');
                const benchmarkWarning = document.getElementById('benchmark-warning');
                const benchmarkWarningMessage = document.getElementById('benchmark-warning-message');
                
                // Update current operation if available
                if (data.current_operation) {
                    currentOperation.textContent = data.current_operation;
                    
                    // Check if this is a warning-worthy operation
                    if (data.current_operation.includes("high max_level") || 
                        data.current_operation.includes("several minutes")) {
                        benchmarkWarning.style.display = 'block';
                        benchmarkWarningMessage.textContent = 
                            "High max_level values (4-5) can cause queries to take several minutes per iteration. " +
                            "This is normal behavior for complex graph queries.";
                    } else {
                        benchmarkWarning.style.display = 'none';
                    }
                }
                
                // Update step progress if available
                if (data.current_step !== undefined && data.total_steps !== undefined) {
                    stepProgress.textContent = data.current_step;
                    totalSteps.textContent = data.total_steps;
                }
                
                // Calculate elapsed time
                if (data.start_time) {
                    const startTime = new Date(data.start_time);
                    const currentTime = new Date();
                    const elapsedSeconds = Math.floor((currentTime - startTime) / 1000);
                    const minutes = Math.floor(elapsedSeconds / 60);
                    const seconds = elapsedSeconds % 60;
                    elapsedTime.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                if (data.status === 'completed') {
                    console.log("Benchmark completed:", currentBenchmarkId);
                    benchmarkStatusTitle.textContent = 'Benchmark Completed';
                    benchmarkStatus.classList.remove('alert-info');
                    benchmarkStatus.classList.add('alert-success');
                    
                    // Load results
                    loadBenchmarks();
                    
                    // Switch to results tab
                    document.getElementById('results-tab').click();
                } else if (data.status === 'failed') {
                    console.error("Benchmark failed:", currentBenchmarkId, data.message);
                    benchmarkStatusTitle.textContent = 'Benchmark Failed';
                    benchmarkStatus.classList.remove('alert-info');
                    benchmarkStatus.classList.add('alert-danger');
                    
                    // Show error details if available
                    if (data.error) {
                        benchmarkWarning.style.display = 'block';
                        benchmarkWarning.className = 'alert alert-danger mt-3';
                        benchmarkWarningMessage.textContent = `Error: ${data.error}`;
                    }
                } else {
                    // Continue polling for running tasks
                    setTimeout(pollBenchmarkStatus, 1000);
                }
            } catch (error) {
                console.error('Error polling benchmark status:', error);
                benchmarkStatusTitle.textContent = 'Error';
                benchmarkStatusMessage.textContent = 'Error polling status. See console for details.';
                benchmarkStatus.classList.remove('alert-info');
                benchmarkStatus.classList.add('alert-danger');
                
                // Try again after a delay
                setTimeout(pollBenchmarkStatus, 5000);
            }
        }
        
        // Load benchmarks
        async function loadBenchmarks() {
            try {
                console.log("Loading benchmarks list");
                const response = await fetch(`${API_BASE_URL}/benchmark/list`);
                const benchmarks = await response.json();
                console.log("Benchmarks list:", benchmarks);
                
                // Clear benchmarks list
                benchmarksList.innerHTML = '';
                
                // Add benchmarks to list
                benchmarks.forEach(benchmark => {
                    console.log("Processing benchmark:", benchmark.id, "Status:", benchmark.status, "Has results:", benchmark.has_results);
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4';
                    
                    let statusClass = 'bg-info';
                    if (benchmark.status === 'completed') {
                        statusClass = 'bg-success';
                    } else if (benchmark.status === 'failed') {
                        statusClass = 'bg-danger';
                    }
                    
                    card.innerHTML = `
                        <div class="card benchmark-card">
                            <div class="card-header ${statusClass} text-white">
                                ${benchmark.id}
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">${benchmark.status.charAt(0).toUpperCase() + benchmark.status.slice(1)}</h5>
                                <p class="card-text">${benchmark.message}</p>
                                <div class="progress mb-3">
                                    <div class="progress-bar" role="progressbar" style="width: ${benchmark.progress}%" aria-valuenow="${benchmark.progress}" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                ${benchmark.has_results ? `<button class="btn btn-primary btn-sm view-results" data-id="${benchmark.id}">View Results</button>` : ''}
                            </div>
                        </div>
                    `;
                    
                    benchmarksList.appendChild(card);
                });
                
                // Add event listeners to view results buttons
                document.querySelectorAll('.view-results').forEach(button => {
                    button.addEventListener('click', () => {
                        loadBenchmarkResults(button.dataset.id);
                    });
                });
            } catch (error) {
                console.error('Error loading benchmarks:', error);
                alert('Error loading benchmarks. See console for details.');
            }
        }
        
        // Load benchmark results
        async function loadBenchmarkResults(benchmarkId) {
            try {
                const response = await fetch(`${API_BASE_URL}/benchmark/results/${benchmarkId}`);
                const data = await response.json();
                
                console.log("Benchmark results data:", data);
                
                // Show result details
                resultDetails.style.display = 'block';
                resultTitle.textContent = `Benchmark Results: ${benchmarkId}`;
                
                // Clear results table
                resultsTableBody.innerHTML = '';
                
                // Store benchmark data globally for chart switching
                window.currentBenchmarkData = data;
                
                // Check if we have results
                if (!data.results) {
                    console.warn("No results data available for benchmark:", benchmarkId);
                    resultsTableBody.innerHTML = `<tr><td colspan="6" class="text-center">No results available. Status: ${data.status}</td></tr>`;
                    return;
                }
                
                // Prepare chart data
                const testNames = [];
                const postgresAvgData = [];
                const neo4jAvgData = [];
                
                // Add results to table and chart data
                if (data.results) {
                    for (const operation in data.results.postgresql) {
                        if (data.results.postgresql[operation] && data.results.neo4j[operation]) {
                            const pgResult = data.results.postgresql[operation];
                            const neo4jResult = data.results.neo4j[operation];
                            
                            // Calculate which is faster
                            const pgAvg = pgResult.avg;
                            const neo4jAvg = neo4jResult.avg;
                            const faster = neo4jAvg < pgAvg ? "Neo4j" : "PostgreSQL";
                            const ratio = pgAvg / neo4jAvg;
                            const speedup = faster === "Neo4j" ? ratio : (1/ratio);
                            
                            // Format the operation name for display
                            const displayName = operation
                                .replace(/_/g, ' ')
                                .replace(/\b\w/g, l => l.toUpperCase());
                            
                            // Add to table
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${displayName}</td>
                                <td>${pgAvg.toFixed(6)}</td>
                                <td>${neo4jAvg.toFixed(6)}</td>
                                <td><span class="badge ${faster === 'PostgreSQL' ? 'bg-primary' : 'bg-danger'}">${faster}</span></td>
                                <td>${speedup.toFixed(2)}x</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info view-details" data-operation="${operation}">
                                        View Details
                                    </button>
                                </td>
                            `;
                            resultsTableBody.appendChild(row);
                            
                            // Add to chart data
                            testNames.push(displayName);
                            postgresAvgData.push(pgAvg);
                            neo4jAvgData.push(neo4jAvg);
                        }
                    }
                }
                
                // Create chart with average data initially
                createChart(testNames, postgresAvgData, neo4jAvgData, 'Average Execution Time');
                
                // Add event listeners for chart type buttons
                document.getElementById('view-avg').addEventListener('click', () => updateChartView('avg'));
                document.getElementById('view-min').addEventListener('click', () => updateChartView('min'));
                document.getElementById('view-max').addEventListener('click', () => updateChartView('max'));
                document.getElementById('view-median').addEventListener('click', () => updateChartView('median'));
                
                // Add event listeners for detail buttons
                document.querySelectorAll('.view-details').forEach(button => {
                    button.addEventListener('click', () => {
                        showOperationDetails(button.dataset.operation);
                    });
                });
            } catch (error) {
                console.error('Error loading benchmark results:', error);
                alert('Error loading benchmark results. See console for details.');
            }
        }
        
        // Show operation details in a modal
        function showOperationDetails(operation) {
            if (!window.currentBenchmarkData) return;
            
            const data = window.currentBenchmarkData;
            const pgData = data.results.postgresql[operation];
            const neo4jData = data.results.neo4j[operation];
            
            if (!pgData || !neo4jData) return;
            
            // Format the operation name for display
            const displayName = operation
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
            
            // Create modal if it doesn't exist
            if (!document.getElementById('details-modal')) {
                const modal = document.createElement('div');
                modal.className = 'modal fade';
                modal.id = 'details-modal';
                modal.tabIndex = '-1';
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Operation Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <h4 id="detail-operation-name"></h4>
                                <div id="data-details" class="mb-4">
                                    <h5>Data Details</h5>
                                    <div id="data-info-container" class="card card-body bg-light mb-3">
                                        <!-- Data details will be populated here -->
                                    </div>
                                </div>
                                <h5>Performance Metrics</h5>
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Metric</th>
                                            <th>PostgreSQL</th>
                                            <th>Neo4j</th>
                                            <th>Difference</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detail-table-body"></tbody>
                                </table>

                                <div id="query-details" class="mt-4" style="display: none;">
                                    <h5>Query Details</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header bg-primary text-white">
                                                    PostgreSQL Query
                                                </div>
                                                <div class="card-body">
                                                    <pre id="pg-query-code" class="mb-0" style="white-space: pre-wrap;"></pre>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card">
                                                <div class="card-header" style="background-color: #018bff; color: white;">
                                                    Neo4j Query
                                                </div>
                                                <div class="card-body">
                                                    <pre id="neo4j-query-code" class="mb-0" style="white-space: pre-wrap;"></pre>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }
            
            // Update modal content
            document.getElementById('detail-operation-name').textContent = displayName;
            const detailTableBody = document.getElementById('detail-table-body');
            detailTableBody.innerHTML = '';
            
            // Add rows for each metric
            const metrics = [
                { name: 'Average', key: 'avg' },
                { name: 'Minimum', key: 'min' },
                { name: 'Maximum', key: 'max' },
                { name: 'Median', key: 'median' }
            ];
            
            metrics.forEach(metric => {
                const pgValue = pgData[metric.key];
                const neo4jValue = neo4jData[metric.key];
                const faster = neo4jValue < pgValue ? 'Neo4j' : 'PostgreSQL';
                const ratio = pgValue / neo4jValue;
                const speedup = faster === 'Neo4j' ? ratio : (1/ratio);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${metric.name}</td>
                    <td>${pgValue.toFixed(6)} s</td>
                    <td>${neo4jValue.toFixed(6)} s</td>
                    <td><span class="badge ${faster === 'PostgreSQL' ? 'bg-primary' : 'bg-danger'}">${faster} is ${speedup.toFixed(2)}x faster</span></td>
                `;
                detailTableBody.appendChild(row);
            });
            
            // Display data details if available
            const dataInfoContainer = document.getElementById('data-info-container');
            const dataDetails = document.getElementById('data-details');
            
            if (pgData.data_info) {
                dataDetails.style.display = 'block';
                let dataInfoHTML = '';
                
                // Add query description if available
                if (pgData.data_info.query_description) {
                    dataInfoHTML += `<p><strong>Query Description:</strong> ${pgData.data_info.query_description}</p>`;
                }
                
                // Add sample data information
                if (pgData.data_info.sample_users) {
                    dataInfoHTML += `<p><strong>Total Users Sampled:</strong> ${pgData.data_info.total_users_sampled}</p>`;
                    dataInfoHTML += '<p><strong>Sample Users:</strong></p>';
                    dataInfoHTML += '<ul class="list-group list-group-flush mb-3">';
                    pgData.data_info.sample_users.slice(0, 3).forEach(user => {
                        dataInfoHTML += `<li class="list-group-item">User ID: ${user.id}, Username: ${user.username}</li>`;
                    });
                    dataInfoHTML += '</ul>';
                }
                
                if (pgData.data_info.sample_products) {
                    dataInfoHTML += `<p><strong>Total Products Sampled:</strong> ${pgData.data_info.total_products_sampled}</p>`;
                    dataInfoHTML += '<p><strong>Sample Products:</strong></p>';
                    dataInfoHTML += '<ul class="list-group list-group-flush mb-3">';
                    pgData.data_info.sample_products.slice(0, 3).forEach(product => {
                        dataInfoHTML += `<li class="list-group-item">Product ID: ${product.id}, Name: ${product.name}</li>`;
                    });
                    dataInfoHTML += '</ul>';
                }
                
                dataInfoContainer.innerHTML = dataInfoHTML;
            } else {
                dataDetails.style.display = 'none';
            }
            
            // Display query details if available
            const queryDetails = document.getElementById('query-details');
            const pgQueryCode = document.getElementById('pg-query-code');
            const neo4jQueryCode = document.getElementById('neo4j-query-code');
            
            if (pgData.data_info && (pgData.data_info.postgresql_query || pgData.data_info.neo4j_query)) {
                queryDetails.style.display = 'block';
                
                if (pgData.data_info.postgresql_query) {
                    pgQueryCode.textContent = pgData.data_info.postgresql_query;
                }
                
                if (pgData.data_info.neo4j_query) {
                    neo4jQueryCode.textContent = pgData.data_info.neo4j_query;
                }
            } else {
                queryDetails.style.display = 'none';
            }
            
            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('details-modal'));
            modal.show();
        }
        
        // Update chart view based on selected metric
        function updateChartView(metric) {
            if (!window.currentBenchmarkData) return;
            
            // Update active button
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`view-${metric}`).classList.add('active');
            
            const data = window.currentBenchmarkData;
            const testNames = [];
            const postgresData = [];
            const neo4jData = [];
            
            // Prepare chart data for the selected metric
            for (const operation in data.results.postgresql) {
                if (data.results.postgresql[operation] && data.results.neo4j[operation]) {
                    // Format the operation name for display
                    const displayName = operation
                        .replace(/_/g, ' ')
                        .replace(/\b\w/g, l => l.toUpperCase());
                    
                    testNames.push(displayName);
                    postgresData.push(data.results.postgresql[operation][metric]);
                    neo4jData.push(data.results.neo4j[operation][metric]);
                }
            }
            
            // Create chart with the selected metric
            const metricTitle = {
                'avg': 'Average',
                'min': 'Minimum',
                'max': 'Maximum',
                'median': 'Median'
            }[metric];
            
            createChart(testNames, postgresData, neo4jData, `${metricTitle} Execution Time`);
        }
        
        // Create chart
        function createChart(labels, postgresData, neo4jData, title) {
            // Destroy existing chart if it exists
            if (resultsChart) {
                resultsChart.destroy();
            }
            
            // Create new chart
            const ctx = document.getElementById('results-chart').getContext('2d');
            resultsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'PostgreSQL (s)',
                            data: postgresData,
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Neo4j (s)',
                            data: neo4jData,
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Time (seconds)'
                            },
                            ticks: {
                                // Include a millisecond formatter to ensure small values are visible
                                callback: function(value) {
                                    return value.toFixed(6) + ' s';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Test'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `PostgreSQL vs Neo4j: ${title}`
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw.toFixed(6)} seconds`;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // Run the benchmark query and process results
        async function runBenchmarkQuery() {
            // ... existing code ...
        }

        // DB Performance Metrics
        document.addEventListener('DOMContentLoaded', function() {
            const taskIdSelect = document.getElementById('task-id-select');
            const loadLatestBtn = document.getElementById('load-latest-metrics-btn');
            const dbMetricsContent = document.getElementById('db-metrics-content');
            const dbMetricsInfo = document.getElementById('db-metrics-info');
            
            // Function to load metrics for a specific task
            function loadMetricsForTask(taskId) {
                if (taskId) {
                    loadMetrics(taskId);
                }
            }
            
            // Make loadMetricsForTask available globally
            window.loadMetricsForTask = loadMetricsForTask;
            
            // Load tasks into dropdown
            async function loadTasks() {
                try {
                    console.log("Loading benchmark tasks for metrics dropdown");
                    const response = await fetch(`${API_BASE_URL}/benchmark/tasks`);
                    if (!response.ok) {
                        console.warn('Tasks endpoint not available, showing only latest metrics option');
                        return;
                    }
                    
                    const data = await response.json();
                    console.log("Tasks loaded:", data);
                    
                    // Clear existing options
                    while (taskIdSelect.options.length > 1) {
                        taskIdSelect.remove(1);
                    }
                    
                    // Add tasks to dropdown
                    data.forEach(task => {
                        const option = document.createElement('option');
                        option.value = task.task_id;
                        option.textContent = `${task.task_id} - ${task.status} - ${new Date(task.start_time).toLocaleString()}`;
                        taskIdSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading tasks:', error);
                }
            }
            
            // Load metrics for a specific task
            async function loadMetrics(taskId) {
                try {
                    dbMetricsInfo.className = 'alert alert-info mb-3';
                    dbMetricsInfo.textContent = 'Loading metrics...';
                    
                    let url = `${API_BASE_URL}/benchmark/metrics/generation/latest`;
                    if (taskId) {
                        url = `${API_BASE_URL}/benchmark/metrics/generation/${taskId}`;
                    }
                    
                    console.log("Fetching metrics from:", url);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log("Metrics data:", data);
                    displayMetrics(data);
                } catch (error) {
                    console.error('Error loading metrics:', error);
                    dbMetricsInfo.textContent = `Error: ${error.message}`;
                    dbMetricsInfo.className = 'alert alert-danger mb-3';
                    dbMetricsContent.style.display = 'none';
                }
            }
            
            // Display metrics on the page
            function displayMetrics(data) {
                // Update counts
                document.getElementById('users-count').textContent = data.counts.users.toLocaleString();
                document.getElementById('products-count').textContent = data.counts.products.toLocaleString();
                document.getElementById('follows-count').textContent = data.counts.follows.toLocaleString();
                document.getElementById('purchases-count').textContent = data.counts.purchases.toLocaleString();
                
                // Update total times
                const pgTotalTime = data.comparison && data.comparison.postgresql ? data.comparison.postgresql.total_time.toFixed(2) : "N/A";
                const neo4jTotalTime = data.comparison && data.comparison.neo4j ? data.comparison.neo4j.total_time.toFixed(2) : "N/A";
                document.getElementById('pg-total-time').textContent = typeof pgTotalTime === 'string' ? pgTotalTime : `${pgTotalTime}s`;
                document.getElementById('neo4j-total-time').textContent = typeof neo4jTotalTime === 'string' ? neo4jTotalTime : `${neo4jTotalTime}s`;
                
                // Update winner
                const overallWinner = document.getElementById('overall-winner');
                
                // Try to calculate the overall winner if not provided directly
                if (data.comparison && data.comparison.faster_db) {
                    // Use the provided faster_db from the API
                    const fasterDb = data.comparison.faster_db;
                    const speedup = data.comparison.overall_speedup || 1;
                    
                    overallWinner.textContent = fasterDb.toUpperCase();
                    const badgeClass = fasterDb === 'postgresql' ? 'bg-primary' : 'bg-info';
                    overallWinner.innerHTML += ` <span class="badge ${badgeClass} winner-badge">${speedup.toFixed(2)}x faster</span>`;
                } else if (data.database_metrics && data.database_metrics.postgresql && data.database_metrics.neo4j) {
                    // Calculate the winner from the metrics data
                    let pgTotalOpTime = 0;
                    let neo4jTotalOpTime = 0;
                    let operationsCount = 0;
                    
                    // Sum up times for all operations
                    const operations = ['users', 'products', 'follows', 'purchases'];
                    operations.forEach(op => {
                        if (data.database_metrics.postgresql[op] && data.database_metrics.neo4j[op]) {
                            pgTotalOpTime += parseFloat(data.database_metrics.postgresql[op].total_time);
                            neo4jTotalOpTime += parseFloat(data.database_metrics.neo4j[op].total_time);
                            operationsCount++;
                        }
                    });
                    
                    if (operationsCount > 0) {
                        const fasterDb = pgTotalOpTime < neo4jTotalOpTime ? 'postgresql' : 'neo4j';
                        const speedup = fasterDb === 'postgresql' 
                            ? neo4jTotalOpTime / pgTotalOpTime 
                            : pgTotalOpTime / neo4jTotalOpTime;
                            
                        overallWinner.textContent = fasterDb.toUpperCase();
                        const badgeClass = fasterDb === 'postgresql' ? 'bg-primary' : 'bg-info';
                        overallWinner.innerHTML += ` <span class="badge ${badgeClass} winner-badge">${speedup.toFixed(2)}x faster</span>`;
                    } else {
                        overallWinner.textContent = "No comparison data available";
                    }
                } else {
                    overallWinner.textContent = "No comparison data available";
                }
                
                // Update operation cards
                const operationsContainer = document.getElementById('operations-container');
                operationsContainer.innerHTML = '';
                
                const operations = ['users', 'products', 'follows', 'purchases'];
                operations.forEach(op => {
                    if (data.database_metrics && 
                        data.database_metrics.postgresql && 
                        data.database_metrics.neo4j && 
                        data.database_metrics.postgresql[op] && 
                        data.database_metrics.neo4j[op]) {
                        
                        const pgTime = data.database_metrics.postgresql[op].total_time.toFixed(2);
                        const neo4jTime = data.database_metrics.neo4j[op].total_time.toFixed(2);
                        const pgRate = data.database_metrics.postgresql[op].rate.toFixed(2);
                        const neo4jRate = data.database_metrics.neo4j[op].rate.toFixed(2);
                        
                        const faster = data.database_metrics.postgresql[op].total_time < data.database_metrics.neo4j[op].total_time ? 'postgresql' : 'neo4j';
                        const speedup = faster === 'postgresql' ? 
                            (data.database_metrics.neo4j[op].total_time / data.database_metrics.postgresql[op].total_time).toFixed(2) :
                            (data.database_metrics.postgresql[op].total_time / data.database_metrics.neo4j[op].total_time).toFixed(2);
                        
                        const opTitle = op.charAt(0).toUpperCase() + op.slice(1);
                        
                        const col = document.createElement('div');
                        col.className = 'col-md-6 mb-3';
                        col.innerHTML = `
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>${opTitle}</span>
                                    <span class="badge ${faster === 'postgresql' ? 'bg-primary' : 'bg-info'}">${faster.toUpperCase()} is ${speedup}x faster</span>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="db-comparison-card db-postgresql card mb-2">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title">PostgreSQL</h6>
                                                    <div class="metric-value">${pgTime}s</div>
                                                    <div class="metric-label">${pgRate} ${op}/sec</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="db-comparison-card db-neo4j card mb-2">
                                                <div class="card-body py-2">
                                                    <h6 class="card-title">Neo4j</h6>
                                                    <div class="metric-value">${neo4jTime}s</div>
                                                    <div class="metric-label">${neo4jRate} ${op}/sec</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                        operationsContainer.appendChild(col);
                    }
                });
                
                // Update memory and errors
                if (data.database_metrics && data.database_metrics.memory) {
                    document.getElementById('peak-memory').textContent = `${data.database_metrics.memory.peak.toFixed(2)} MB`;
                    document.getElementById('final-memory').textContent = `${data.database_metrics.memory.final.toFixed(2)} MB`;
                } else {
                    document.getElementById('peak-memory').textContent = "N/A";
                    document.getElementById('final-memory').textContent = "N/A";
                }
                
                if (data.database_metrics && data.database_metrics.errors) {
                    document.getElementById('pg-errors').textContent = data.database_metrics.errors.postgresql || 0;
                    document.getElementById('neo4j-errors').textContent = data.database_metrics.errors.neo4j || 0;
                } else {
                    document.getElementById('pg-errors').textContent = "N/A";
                    document.getElementById('neo4j-errors').textContent = "N/A";
                }
                
                // Show content
                dbMetricsInfo.className = 'alert alert-success mb-3';
                dbMetricsInfo.textContent = `Displaying metrics for task ${data.task_id} completed at ${new Date(data.end_time).toLocaleString()}`;
                dbMetricsContent.style.display = 'block';
            }
            
            // Event listeners
            if (taskIdSelect) {
                taskIdSelect.addEventListener('change', function() {
                    if (this.value) {
                        loadMetrics(this.value);
                    }
                });
            }
            
            if (loadLatestBtn) {
                loadLatestBtn.addEventListener('click', function() {
                    loadMetrics();
                });
            }
            
            // DB metrics tab selected
            const dbMetricsTab = document.getElementById('db-metrics-tab');
            if (dbMetricsTab) {
                dbMetricsTab.addEventListener('click', function() {
                    loadTasks();
                });
            }
        });
    </script>
</body>
</html> 